name: Full Auto CI/CD (Clean & Deploy)

on:
  push:
    branches: ["main"]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout k√≥du
        uses: actions/checkout@v4

      - name: Nastaven√≠ Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      # 1. KROK: Smaz√°n√≠ star√©ho automatick√©ho release (aby byl v seznamu v≈ædy jen jeden)
      - name: Smaz√°n√≠ star√©ho Auto-Buildu
        uses: dev-drprasad/delete-tag-and-release@v1.1
        with:
          delete_release: true
          tag_name: latest-autobuild # Tento tag budeme recyklovat
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 2. KROK: Vytvo≈ôen√≠ ZIP bal√≠ƒçku
      - name: Vytvo≈ôen√≠ ZIP bal√≠ƒçku
        run: zip -r fixit-guru-latest.zip . -x "*.git*" ".github*"

      # 3. KROK: Vytvo≈ôen√≠ nov√©ho ƒçerstv√©ho Release
      - name: Publikovat ƒçerstv√Ω Auto-Build
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest-autobuild
          name: üöÄ FIXIT-GURU | Aktu√°ln√≠ Sestaven√≠
          body: |
            ### ü§ñ Automaticky udr≈æovan√© sestaven√≠
            Tento release je automaticky aktualizov√°n p≈ôi ka≈æd√©m pushi do main.
            V≈ædy zde najdete nejnovƒõj≈°√≠ verzi j√°dra **Fixit-guru**.
            
            - **Posledn√≠ aktualizace:** ${{ github.event.head_commit.timestamp }}
            - **Commit:** ${{ github.sha }}
            - **Web dema:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
          files: fixit-guru-latest.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 4. KROK: Nasazen√≠ webu z /www
      - name: Nastaven√≠ Pages
        uses: actions/configure-pages@v4

      - name: Nahr√°n√≠ artefaktu pro web
        uses: actions/upload-pages-artifact@v3
        with:
          path: './www'

      - name: Nasazen√≠ na GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
